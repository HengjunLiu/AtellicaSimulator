# Atellica Simulator 开发文档

## 项目结构

```
AtellicaSimulator/
├── core/          # 核心模拟逻辑
├── las/           # LAS通信模块
├── lis/           # LIS通信模块
├── ui/            # 用户界面模块
├── config/        # 配置管理模块
├── logger/        # 日志模块
├── main.py        # 主程序入口
├── test_simulator.py # 测试脚本
├── README.md      # 用户手册
├── DEVELOPMENT.md # 开发文档
└── config.json    # 配置文件模板
```

## 模块设计

### 1. Core 模块

**设计思路**：
- 负责设备状态管理和样本处理流程
- 采用线程安全设计，使用锁保护共享数据
- 支持动态更新设备状态和库存信息
- 实现样本接收、处理和结果生成的完整流程

**主要类**：
- `AtellicaCore`：核心模拟逻辑类

**核心功能**：
- 设备状态管理（自动化接口状态、仪器处理状态等）
- 测试项目库存管理
- 耗材库存管理
- 样本接收和处理
- 结果生成和回调机制

### 2. LAS 模块

**设计思路**：
- 严格按照《Atellica_Solution_LAS_Interface_Guide.md》实现uRAP协议
- 采用TCP/IP服务端模式，支持多客户端连接
- 实现消息解析、构建和校验
- 支持异步消息处理和响应

**主要类**：
- `LASServer`：LAS通信服务器类

**核心功能**：
- uRAP协议消息处理
- 握手协议实现
- 仪器健康状态响应
- 测试和耗材库存响应
- 在线样本信息响应

### 3. LIS 模块

**设计思路**：
- 实现ASTM E1394标准协议
- 支持标本工单接收和结果发送
- 采用TCP/IP服务端模式
- 实现消息解析和构建

**主要类**：
- `LISServer`：LIS通信服务器类

**核心功能**：
- ASTM协议消息处理
- 标本工单接收
- 测试结果生成和发送
- 30分钟结果延迟机制

### 4. UI 模块

**设计思路**：
- 使用Tkinter库实现跨平台GUI
- 采用模块化设计，支持动态更新
- 实现实时状态显示和参数配置
- 支持独立的日志显示区域

**主要类**：
- `AtellicaUI`：用户界面类

**核心功能**：
- 设备状态实时显示
- 参数配置界面
- 详细状态信息展示
- LAS和LIS日志显示

### 5. Config 模块

**设计思路**：
- 使用JSON格式存储配置
- 支持默认配置和自定义配置
- 实现配置的动态加载和保存
- 提供配置访问接口

**主要类**：
- `ConfigManager`：配置管理类

**核心功能**：
- 配置文件加载
- 配置参数访问
- 配置更新和保存

### 6. Logger 模块

**设计思路**：
- 采用Python内置logging库
- 支持分级日志
- 实现分离式日志（系统日志、LAS日志、LIS日志）
- 支持日志文件轮换

**主要类**：
- `Logger`：日志管理类

**核心功能**：
- 系统运行日志记录
- LAS通信日志记录
- LIS通信日志记录
- 日志文件管理

## 通信协议实现

### uRAP 协议

**消息格式**：
- 起始标志：STX (0x02)
- 消息头：包含消息长度、序列ID、消息类型等
- 消息体：具体消息内容
- 消息尾：校验和和结束标志 ETX (0x03)

**校验和计算**：
- 计算消息头和消息体的二进制和
- 转换为2位十六进制ASCII字符串
- 取模256

### ASTM 协议

**消息格式**：
- 记录分隔符：CR (\x0d)
- 字段分隔符：| (管道符)
- 组件分隔符：^ (脱字符)
- 重复分隔符：~ (波浪线)
- 转义分隔符：\ (反斜杠)

**记录类型**：
- H：头记录
- P：患者记录
- O：订单记录
- R：结果记录
- C：注释记录
- L：终止记录

## 线程模型

- **主线程**：负责UI事件处理和主程序控制
- **LAS服务线程**：接受LAS客户端连接
- **LIS服务线程**：接受LIS客户端连接
- **LAS连接线程**：处理每个LAS连接的消息
- **LIS连接线程**：处理每个LIS连接的消息
- **结果生成线程**：定期检查并生成样本结果
- **状态更新线程**：定期更新UI状态
- **日志更新线程**：定期更新日志显示

## 代码规范

- 采用PEP 8代码风格
- 使用类型注解提高代码可读性
- 详细的文档字符串
- 模块化设计，低耦合高内聚
- 完善的错误处理机制

## 测试策略

- 单元测试：对关键功能进行单元测试
- 集成测试：测试模块间的协同工作
- 系统测试：测试完整的模拟流程
- 自动化测试：支持无UI模式下的自动测试

## 扩展建议

### 添加新的消息类型
1. 在相应的通信模块中添加消息类型常量
2. 实现消息解析和处理逻辑
3. 实现消息构建和发送逻辑
4. 更新配置文件支持新参数

### 扩展设备状态参数
1. 在core模块中添加新的状态属性
2. 更新配置文件模板
3. 在UI中添加相应的显示和配置控件
4. 更新通信模块中的状态报告逻辑

### 支持新的通信协议
1. 创建新的通信模块
2. 实现协议的服务器端
3. 集成到主程序中
4. 添加相应的配置选项

## 性能优化

- 采用异步IO提高并发处理能力
- 使用线程池管理连接线程
- 优化日志写入性能
- 实现高效的消息解析算法

## 安全性考虑

- 实现完整的错误处理机制
- 防止缓冲区溢出
- 验证输入数据的合法性
- 保护共享数据的线程安全
- 定期清理资源，防止内存泄漏
