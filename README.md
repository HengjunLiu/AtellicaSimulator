# Atellica Solution Simulator

## 概述

Atellica Solution Simulator 是一个精确模拟西门子医疗检验设备 Atellica Solution 核心功能的模拟器。该模拟器能够与实验室自动化系统(LAS)和医院实验室信息系统(LIS)进行数据交互，支持有UI和无UI两种运行模式，适用于系统集成测试和开发环境。

## 功能特性

### 数据交互功能
- **LAS 通信**：支持与实验室自动化系统(LAS)的 TCP/IP 通讯，采用 uRAP 协议
- **LIS 通信**：支持与医院实验室信息系统(LIS)的 TCP/IP 通讯，采用 ASTM 协议
- **样本处理**：接收标本工单信息，30分钟后自动生成随机结果并发送回 LIS

### 用户界面
- 显示模拟器关键运行参数
- 支持手动修改仪器运行状况参数
- 独立的 LAS 和 LIS 通讯日志显示区域

### 运行模式
- **有UI模式**：完整的图形用户界面，支持人工操作和监控
- **无UI模式**：命令行/后台运行模式，支持自动执行测试案例

## 系统架构

采用模块化设计，各模块低耦合：
- **core**：核心模拟逻辑，处理设备状态管理和样本处理
- **las**：LAS 通信模块，实现 uRAP 协议服务端
- **lis**：LIS 通信模块，实现 ASTM 协议服务端
- **ui**：用户界面模块，提供图形化操作和监控
- **config**：配置管理模块，处理参数配置和持久化
- **logger**：日志模块，记录系统运行和通信日志

## 安装

### 环境要求
- Python 3.8 或更高版本
- 无额外第三方依赖

### 安装步骤
1. 克隆或下载项目代码到本地
2. 确保 Python 环境已正确安装
3. 无需安装额外依赖包

## 配置

### 配置文件
系统使用 JSON 格式的配置文件，默认文件名为 `config.json`，包含以下主要配置项：

- **logger**：日志配置
- **las**：LAS 通信配置
- **lis**：LIS 通信配置
- **core**：核心模拟参数
- **test_inventory**：测试项目库存
- **consumable_inventory**：耗材库存

### 配置示例
```json
{
    "logger": {
        "level": "INFO",
        "console_output": true,
        "file_output": true
    },
    "las": {
        "host": "0.0.0.0",
        "port": 10001
    },
    "lis": {
        "host": "0.0.0.0",
        "port": 10002,
        "result_delay": 1800
    }
}
```

## 使用方法

### 启动模拟器

#### 有UI模式
```bash
python main.py
```

#### 无UI模式
```bash
python main.py --no-ui
```

#### 指定配置文件
```bash
python main.py --config my_config.json
```

### 命令行参数
- `--no-ui`：无UI模式运行
- `--config`：指定配置文件路径

### 主要操作

#### 有UI模式
1. 启动模拟器后，主界面显示设备状态和运行参数
2. 在"参数配置"选项卡中可以修改设备状态
3. 在"详细状态"区域查看完整设备信息
4. 在"通讯日志"选项卡查看 LAS 和 LIS 通讯日志

#### 无UI模式
- 后台运行，所有日志输出到日志文件
- 适合自动化测试和集成环境

## 通信协议

### LAS 通信 (uRAP 协议)
- 监听端口：默认 10001
- 协议类型：TCP/IP
- 支持消息类型：
  - 握手消息
  - 仪器健康状态
  - 测试项目库存
  - 在线样本信息
  - 耗材库存

### LIS 通信 (ASTM 协议)
- 监听端口：默认 10002
- 协议类型：TCP/IP
- 支持消息类型：
  - 标本工单接收
  - 测试结果发送

## 日志管理

日志文件默认存储在 `logs` 目录下：
- `atellica_simulator.log`：系统运行日志
- `las_communication.log`：LAS 通信日志
- `lis_communication.log`：LIS 通信日志

## 测试

### 运行测试脚本
```bash
python test_simulator.py
```

测试脚本会验证核心功能，包括：
- 仪器健康状态获取
- 测试项目库存管理
- 耗材库存管理
- 样本接收和处理
- 设备状态更新

## 开发扩展

### 系统架构
系统采用模块化设计，各模块通过接口交互，便于扩展和修改：

### 核心模块接口
- `AtellicaCore`：提供设备状态管理和样本处理接口
- `LASServer`：提供 LAS 通信接口
- `LISServer`：提供 LIS 通信接口

### 添加新功能
1. 在对应模块中添加新的类或方法
2. 更新配置文件支持新参数
3. 在 UI 中添加相应的控制界面

## 注意事项

1. 模拟器仅用于测试和开发环境，不得用于生产环境
2. 确保端口配置不与其他服务冲突
3. 定期清理日志文件，避免占用过多磁盘空间
4. 配置文件中的敏感信息应妥善保管

## 版本历史

- v1.0.0：初始版本，实现核心功能

## 联系方式

如有问题或建议，请联系开发团队。

## 许可证

本项目采用 MIT 许可证。
