# AtellicaSimulator开发计划

## 1. 系统架构设计

采用模块化设计，将系统划分为以下核心模块：

- **core**: 核心模拟逻辑，处理设备状态管理、样本处理流程
- **las**: LAS通信模块，实现uRAP协议的TCP/IP服务端
- **lis**: LIS通信模块，实现ASTM协议的TCP/IP服务端
- **ui**: 用户界面模块，提供图形化操作和监控界面
- **config**: 配置管理模块，处理参数配置和持久化
- **logger**: 日志模块，记录系统运行和通信日志

## 2. 模块详细设计

### 2.1 core模块
- 设备状态管理：自动化接口状态、仪器处理状态、LIS连接状态等
- 样本处理流程：样本接收、处理、结果生成（30分钟后）
- 测试 inventory 模拟：支持动态修改测试项目状态和可用数量
- 耗材 inventory 模拟：支持动态修改耗材状态

### 2.2 las模块
- 基于TCP/IP的uRAP协议服务端实现
- 支持握手协议、消息确认机制、保活机制
- 实现所有uRAP消息类型：
  - 握手消息 (0x0001)
  - 确认消息 (0x0000)
  - 仪器健康消息 (0x0201/0x0202)
  - 测试 inventory 消息 (0x0203/0x0204)
  - 样本信息消息 (0x0207/0x0208)
  - 耗材 inventory 消息 (0x020B/0x020C)
  - 初始化完成消息 (0x020D)

### 2.3 lis模块
- 基于TCP/IP的ASTM协议服务端实现
- 支持样本工单接收
- 30分钟后自动生成随机结果并发送回LIS
- 支持ASTM消息解析和构建

### 2.4 ui模块
- 主界面显示关键运行参数：
  - 自动化接口状态、仪器处理状态、LIS连接状态
  - 接口位置状态、锁所有权
  - 处理积压、样本获取延迟
  - 在线试管数量、已完成试管数量
- 可配置参数区域：
  - 设备状态参数
  - 测试项目和耗材状态
  - 通信配置
- 分离的日志显示区域：
  - LAS通信日志
  - LIS通信日志

### 2.5 运行模式
- **UI模式**：完整的图形用户界面，支持人工操作和监控
- **无UI模式**：命令行/后台运行模式，支持通过配置文件或命令行参数进行配置，适合AI编程工具自动执行测试案例

## 3. 技术选型

- **开发语言**：Python 3.8+
- **GUI框架**：Tkinter（内置库，无需额外安装）
- **网络通信**：Python标准库socket
- **日志处理**：Python标准库logging
- **配置管理**：JSON配置文件
- **数据序列化**：struct库（用于uRAP协议二进制数据处理）

## 4. 实现步骤

1. **搭建项目基础结构**：创建目录结构和基础文件
2. **实现core模块**：核心模拟逻辑
3. **实现las模块**：uRAP协议服务端
4. **实现lis模块**：ASTM协议服务端
5. **实现config和logger模块**：配置管理和日志功能
6. **实现ui模块**：图形用户界面
7. **实现无UI模式**：命令行接口
8. **集成测试**：各模块集成测试
9. **文档编写**：用户手册和开发文档

## 5. 关键实现细节

- **uRAP协议实现**：严格按照文档规范实现消息头、消息体、消息尾的解析和构建
- **ASTM协议实现**：参考ASTM E1394标准实现
- **样本处理流程**：使用定时器模拟30分钟的样本处理时间
- **日志管理**：实现分级日志，支持日志文件和控制台输出
- **参数验证**：确保配置参数的有效性和合法性
- **错误处理**：实现全面的错误捕获和处理机制

## 6. 预期交付物

- AtellicaSimulator主程序
- 配置文件模板
- 用户手册
- 开发文档
- 测试脚本示例

该计划将确保AtellicaSimulator实现所有要求的功能，同时保持良好的模块化设计和可扩展性。